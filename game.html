<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶²é«”æ’åºæ‹¼åœ– (Water Sort Puzzle)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --tube-border: #dcdcdc;
            --tube-width: 60px;
            --tube-height: 200px; /* ç¨å¾®èª¿çŸ®ä¸€é»ä»¥é©æ‡‰ç•«é¢ */
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            overflow-x: hidden; /* é˜²æ­¢æ‰‹æ©Ÿå·¦å³æ»‘å‹• */
        }

        h1 {
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 1.8rem;
        }

        .controls {
            margin-bottom: 20px;
        }

        button {
            background-color: #f39c12;
            border: none;
            padding: 10px 25px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s, background-color 0.2s;
        }

        button:hover {
            background-color: #e67e22;
        }

        button:active {
            transform: scale(0.95);
        }

        /* éŠæˆ²å€åŸŸä½ˆå±€ï¼šå¼·åˆ¶ 5 åˆ— */
        #game-board {
            display: grid;
            grid-template-columns: repeat(5, auto); /* ä¸€æ’5å€‹ */
            gap: 40px 15px; /* è¡Œè·40px, åˆ—è·15px */
            justify-content: center;
            align-content: center;
            max-width: 100%;
        }

        .tube {
            width: var(--tube-width);
            height: var(--tube-height);
            border: 4px solid var(--tube-border);
            border-top: none;
            border-radius: 0 0 25px 25px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.05);
            /* è®“é»æ“Šå€åŸŸå¤§ä¸€é» */
            touch-action: manipulation; 
        }

        .tube.selected {
            transform: translateY(-20px);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            border-color: #fff;
        }

        .liquid {
            width: 100%;
            height: 25%;
            position: absolute;
            bottom: 0;
            transition: height 0.3s ease, bottom 0.3s ease;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .pos-0 { bottom: 0%; }
        .pos-1 { bottom: 25%; }
        .pos-2 { bottom: 50%; }
        .pos-3 { bottom: 75%; }

        /* é®ç½©æ¨£å¼ */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .overlay-text {
            font-size: 3rem;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }

        .win-text { color: #2ecc71; text-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
        .lose-text { color: #e74c3c; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }

        .overlay-desc {
            color: #ccc;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        /* æ‰‹æ©Ÿé©é…ï¼šå¦‚æœè¢å¹•å¤ªå°ï¼Œç¸®å°è©¦ç®¡ */
        @media (max-width: 450px) {
            :root {
                --tube-width: 45px;
                --tube-height: 160px;
            }
            #game-board {
                gap: 30px 10px;
            }
        }

    </style>
</head>
<body>

    <h1>æ¶²é«”æ’åºæ‹¼åœ–</h1>
    <div class="controls">
        <button onclick="initGame()">é‡æ–°é–‹å§‹</button>
    </div>

    <div id="game-board">
        </div>

    <div id="win-overlay" class="overlay">
        <div class="overlay-text win-text">æ­å–œéé—œï¼ ğŸ‰</div>
        <button onclick="initGame()">ä¸‹ä¸€å±€</button>
    </div>

    <div id="lose-overlay" class="overlay">
        <div class="overlay-text lose-text">æ­»å±€ï¼ ğŸ˜±</div>
        <div class="overlay-desc">å·²ç¶“æ²’æœ‰å¯ä»¥ç§»å‹•çš„æ­¥æ•¸äº†</div>
        <button onclick="initGame()">é‡æ–°æŒ‘æˆ°</button>
    </div>

    <script>
        /**
         * éŠæˆ²é…ç½®
         * 1. 7 ç¨®é«˜å°æ¯”é¡è‰²
         * 2. 10 æ ¹è©¦ç®¡
         * 3. 3 å€‹ç©ºç“¶
         */
        const COLORS = [
            '#FF3B30', // é®®ç´… (Red)
            '#007AFF', // äº®è— (Blue)
            '#4CD964', // é®®ç¶  (Green)
            '#FFCC00', // äº®é»ƒ (Yellow)
            '#9B59B6', // ç´«è‰² (Purple)
            '#FF9500', // æ©˜è‰² (Orange)
            '#00C7BE', // é’è‰²/ç¶ æ¾çŸ³ (Teal/Cyan)
        ];
        
        const TUBE_CAPACITY = 4;
        const NUM_TUBES = 10; 
        const NUM_EMPTY = 3;  // 3å€‹ç©ºç“¶
        
        let tubes = [];
        let selectedTubeIndex = null;
        let isAnimating = false;

        const board = document.getElementById('game-board');
        const winOverlay = document.getElementById('win-overlay');
        const loseOverlay = document.getElementById('lose-overlay');

        function initGame() {
            tubes = [];
            selectedTubeIndex = null;
            isAnimating = false;
            winOverlay.classList.remove('active');
            loseOverlay.classList.remove('active');
            generateLevel();
            render();
        }

        function generateLevel() {
            let allLiquids = [];
            const numFilledTubes = NUM_TUBES - NUM_EMPTY; // 10 - 3 = 7
            
            // æ ¹æ“šå¡«å……è©¦ç®¡çš„æ•¸é‡ (7) é¸å–å‰ 7 ç¨®é¡è‰²
            // é€™æ¨£ç¢ºä¿é¡è‰²æ•¸é‡å‰›å¥½å°æ‡‰éœ€è¦å¡«æ»¿çš„è©¦ç®¡æ•¸
            for (let i = 0; i < numFilledTubes; i++) {
                let color = COLORS[i]; 
                for (let j = 0; j < TUBE_CAPACITY; j++) {
                    allLiquids.push(color);
                }
            }

            // æ´—ç‰Œç®—æ³•
            for (let i = allLiquids.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allLiquids[i], allLiquids[j]] = [allLiquids[j], allLiquids[i]];
            }

            // åˆ†é…åˆ°è©¦ç®¡
            for (let i = 0; i < NUM_TUBES; i++) {
                tubes[i] = [];
                // å‰ 7 æ ¹å¡«æ»¿ï¼Œå¾Œ 3 æ ¹ç•™ç©º
                if (i < numFilledTubes) {
                    for (let j = 0; j < TUBE_CAPACITY; j++) {
                        tubes[i].push(allLiquids.pop());
                    }
                }
            }
            
            // æª¢æŸ¥é–‹å±€æ˜¯å¦å°±æ˜¯æ­»å±€ï¼ˆæ¥µä½æ©Ÿç‡ï¼‰ï¼Œå¦‚æœæ˜¯å‰‡é‡é–‹
            if (checkStuckState() && !checkWinState()) {
                generateLevel();
            }
        }

        function render() {
            board.innerHTML = '';
            
            tubes.forEach((tube, index) => {
                const tubeDiv = document.createElement('div');
                tubeDiv.className = `tube ${index === selectedTubeIndex ? 'selected' : ''}`;
                tubeDiv.onclick = () => handleTubeClick(index);

                // æ¸²æŸ“æ¶²é«”
                tube.forEach((color, i) => {
                    const liquidDiv = document.createElement('div');
                    liquidDiv.className = `liquid pos-${i}`;
                    liquidDiv.style.backgroundColor = color;
                    tubeDiv.appendChild(liquidDiv);
                });

                board.appendChild(tubeDiv);
            });
        }

        function handleTubeClick(index) {
            if (isAnimating) return; // å‹•ç•«ä¸­ç¦æ­¢é»æ“Š

            // 1. å–æ¶ˆé¸å–
            if (selectedTubeIndex === index) {
                selectedTubeIndex = null;
                render();
                return;
            }

            // 2. é¸æ“‡ä¾†æº
            if (selectedTubeIndex === null) {
                if (tubes[index].length > 0) {
                    selectedTubeIndex = index;
                    render();
                }
                return;
            }

            // 3. å˜—è©¦ç§»å‹•
            attemptMove(selectedTubeIndex, index);
        }

        function attemptMove(fromIndex, toIndex) {
            const sourceTube = tubes[fromIndex];
            const destTube = tubes[toIndex];

            // ä¾†æºå¿…é ˆæœ‰æ°´
            if (sourceTube.length === 0) return;

            const colorToMove = sourceTube[sourceTube.length - 1];
            
            // è¦å‰‡æª¢æŸ¥ï¼š
            // A. ç›®æ¨™æœªæ»¿
            // B. ç›®æ¨™æ˜¯ç©ºçš„ æˆ–è€… ç›®æ¨™æœ€ä¸Šå±¤é¡è‰²èˆ‡ä¾†æºç›¸åŒ
            if (destTube.length < TUBE_CAPACITY) {
                if (destTube.length === 0 || destTube[destTube.length - 1] === colorToMove) {
                    executeMove(fromIndex, toIndex);
                } else {
                    // é¡è‰²ä¸ç¬¦ï¼Œå–æ¶ˆé¸å–
                    selectedTubeIndex = null;
                    render();
                }
            } else {
                // ç›®æ¨™å·²æ»¿ï¼Œå–æ¶ˆé¸å–
                selectedTubeIndex = null;
                render();
            }
        }

        function executeMove(fromIndex, toIndex) {
            const sourceTube = tubes[fromIndex];
            const destTube = tubes[toIndex];
            const colorToMove = sourceTube[sourceTube.length - 1];

            // è¨ˆç®—ä¸€æ¬¡èƒ½å€’å¹¾æ ¼ï¼ˆä¾†æºæœ‰å¤šå°‘å€‹é€£çºŒç›¸åŒé¡è‰² vs ç›®æ¨™å‰©é¤˜ç©ºé–“ï¼‰
            let sourceColorCount = 0;
            for (let i = sourceTube.length - 1; i >= 0; i--) {
                if (sourceTube[i] === colorToMove) sourceColorCount++;
                else break;
            }

            let availableSpace = TUBE_CAPACITY - destTube.length;
            let actualMoveAmount = Math.min(sourceColorCount, availableSpace);

            if (actualMoveAmount > 0) {
                // åŸ·è¡Œç§»å‹•
                for (let i = 0; i < actualMoveAmount; i++) {
                    destTube.push(sourceTube.pop());
                }
                
                selectedTubeIndex = null;
                render();
                
                // å»¶é²æª¢æŸ¥è¼¸è´ï¼Œè®“ç©å®¶çœ‹åˆ°æ°´å€’é€²å»
                setTimeout(() => {
                    if (checkWinState()) {
                        winOverlay.classList.add('active');
                    } else if (checkStuckState()) {
                        loseOverlay.classList.add('active');
                    }
                }, 250);

            } else {
                selectedTubeIndex = null;
                render();
            }
        }

        // æª¢æŸ¥å‹åˆ©
        function checkWinState() {
            return tubes.every(tube => {
                // ç©ºç“¶ OK
                if (tube.length === 0) return true;
                // å¿…é ˆæ»¿ ä¸” é¡è‰²ä¸€è‡´
                if (tube.length !== TUBE_CAPACITY) return false;
                const firstColor = tube[0];
                return tube.every(color => color === firstColor);
            });
        }

        // æª¢æŸ¥æ­»å±€ (Stuck)
        function checkStuckState() {
            if (checkWinState()) return false; // è´äº†å°±ä¸ç®—æ­»å±€

            // çª®èˆ‰æ‰€æœ‰å¯èƒ½çš„ç§»å‹•
            for (let i = 0; i < NUM_TUBES; i++) {
                if (tubes[i].length === 0) continue; // ä¾†æºæ˜¯ç©ºçš„è·³é

                let colorToMove = tubes[i][tubes[i].length - 1];

                for (let j = 0; j < NUM_TUBES; j++) {
                    if (i === j) continue; // ä¸æª¢æŸ¥è‡ªå·±

                    let destTube = tubes[j];
                    // åªè¦æ‰¾åˆ°ä¸€å€‹åˆæ³•çš„ç§»å‹•ï¼Œå°±ä¸æ˜¯æ­»å±€
                    if (destTube.length < TUBE_CAPACITY) {
                        if (destTube.length === 0 || destTube[destTube.length - 1] === colorToMove) {
                            return false; 
                        }
                    }
                }
            }
            // è·‘å®Œæ‰€æœ‰çµ„åˆéƒ½æ²’æ­¥æ•¸
            return true;
        }

        // å•Ÿå‹•éŠæˆ²
        initGame();
    </script>
</body>
</html>